name: CD - Deploy Vote Application

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Target Server Environment'
        required: true
        type: choice
        options:
          - dev
          - prod
        default: 'dev'

env:
  REGISTRY: docker.io
  IMAGE_NAME: vote-app

jobs:
  deploy-dev:
    if: inputs.environment == 'dev'
    name: Deploy to Development
    runs-on: homeserver
    environment: dev

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up environment variables
        run: |
          echo "DOCKER_USERNAME=${{ secrets.DOCKER_ID }}" >> $GITHUB_ENV
          echo "DOCKER_PASSWORD=${{ secrets.DOCKER_PW }}" >> $GITHUB_ENV
          echo "CONTAINER_NAME=vote-app-dev" >> $GITHUB_ENV
          echo "DEPLOY_PORT=18080" >> $GITHUB_ENV
          echo "IMAGE_TAG=dev-${{ github.sha }}" >> $GITHUB_ENV
          echo "TARGET_IMAGE=${{ env.REGISTRY }}/${{ secrets.DOCKER_ID }}/${{ env.IMAGE_NAME }}:dev-${{ github.sha }}" >> $GITHUB_ENV

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ env.DOCKER_USERNAME }}
          password: ${{ env.DOCKER_PASSWORD }}

      - name: Pull Docker image
        run: |
          echo "Pulling Docker image: ${{ env.TARGET_IMAGE }}"
          docker pull ${{ env.TARGET_IMAGE }}

      - name: Deploy to development environment
        run: |
          echo "Deploying to development environment..."

          # Stop and remove existing container
          docker stop ${{ env.CONTAINER_NAME }} || true
          docker rm ${{ env.CONTAINER_NAME }} || true

          # Start new container
          docker run -d \
            --name ${{ env.CONTAINER_NAME }} \
            --restart unless-stopped \
            -p ${{ env.DEPLOY_PORT }}:8080 \
            -e JWT_SECRET_KEY="${{ secrets.JWT_SECRET_KEY }}" \
            -e PASSWORD_SECRET_KEY="${{ secrets.PASSWORD_SECRET_KEY }}" \
            -e PORTONE_STORE_ID="${{ secrets.PORTONE_STORE_ID }}" \
            -e PORTONE_AUTH_TOKEN="${{ secrets.PORTONE_AUTH_TOKEN }}" \
            -e DB_URL="${{ secrets.DB_URL }}" \
            -e DB_USERNAME="${{ secrets.DB_USERNAME }}" \
            -e DB_PASSWORD="${{ secrets.DB_PASSWORD }}" \
            ${{ env.TARGET_IMAGE }}

          echo "Development container started successfully"
          docker ps --filter "name=${{ env.CONTAINER_NAME }}"

      - name: Verify deployment
        run: |
          echo "Waiting for application to start..."
          sleep 15

          # Check if container is running locally
          if docker ps --filter "name=${{ env.CONTAINER_NAME }}" --filter "status=running" | grep -q ${{ env.CONTAINER_NAME }}; then
            echo "‚úÖ Development container is running successfully"

            # Health check with retry
            for i in {1..5}; do
              if curl -f -s http://localhost:${{ env.DEPLOY_PORT }}/actuator/health > /dev/null 2>&1; then
                echo "‚úÖ Development health check passed"
                break
              else
                echo "‚è≥ Development health check attempt $i/5 failed, retrying in 5s..."
                sleep 5
              fi

              if [ $i -eq 5 ]; then
                echo "‚ö†Ô∏è Development health check endpoint not responding"
                echo "üìã Container logs:"
                docker logs --tail 20 ${{ env.CONTAINER_NAME }}
              fi
            done
          else
            echo "‚ùå Development container failed to start"
            echo "üìã Container logs:"
            docker logs ${{ env.CONTAINER_NAME }}
            exit 1
          fi

      - name: Clean up old Docker images
        run: |
          echo "Cleaning up old Docker images..."

          # Get current image ID
          CURRENT_IMAGE_ID=$(docker images ${{ env.TARGET_IMAGE }} --format "{{.ID}}" | head -n 1)
          echo "Current image ID: $CURRENT_IMAGE_ID"

          # Get all images for this repository (excluding the current one)
          OLD_IMAGES=$(docker images ${{ env.REGISTRY }}/${{ env.DOCKER_USERNAME }}/${{ env.IMAGE_NAME }} --format "{{.ID}} {{.Tag}}" | grep -v "$CURRENT_IMAGE_ID" | head -n -1 | awk '{print $1}')

          if [ -n "$OLD_IMAGES" ]; then
            echo "Removing old images (keeping 1 backup):"
            echo "$OLD_IMAGES"
            echo "$OLD_IMAGES" | xargs -r docker rmi -f || true
          else
            echo "No old images to clean up"
          fi

          # Clean up dangling images
          echo "Cleaning up dangling images..."
          docker image prune -f || true

      - name: Show deployment summary
        run: |
          echo "üöÄ Deployment Summary"
          echo "===================="
          echo "Environment: dev"
          echo "Branch: ${{ github.ref_name }}"
          echo "Built Image: ${{ env.TARGET_IMAGE }}"
          echo "Container: ${{ env.CONTAINER_NAME }}"
          echo "Port: ${{ env.DEPLOY_PORT }}"
          echo ""
          echo "Container Status:"
          docker ps --filter "name=${{ env.CONTAINER_NAME }}" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
          echo ""
          echo "üåê Access URL: http://localhost:${{ env.DEPLOY_PORT }}"

  deploy-prod:
    if: inputs.environment == 'prod'
    name: Deploy to Production
    runs-on: nppd_on-prem
    environment: prod

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up environment variables
        run: |
          echo "DOCKER_USERNAME=${{ secrets.DOCKER_ID }}" >> $GITHUB_ENV
          echo "DOCKER_PASSWORD=${{ secrets.DOCKER_PW }}" >> $GITHUB_ENV
          echo "CONTAINER_NAME=vote-app-prod" >> $GITHUB_ENV
          echo "DEPLOY_PORT=8080" >> $GITHUB_ENV
          echo "IMAGE_TAG=prod-${{ github.sha }}" >> $GITHUB_ENV
          echo "TARGET_IMAGE=${{ env.REGISTRY }}/${{ secrets.DOCKER_ID }}/${{ env.IMAGE_NAME }}:prod-${{ github.sha }}" >> $GITHUB_ENV

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ env.DOCKER_USERNAME }}
          password: ${{ env.DOCKER_PASSWORD }}

      - name: Pull Docker image
        run: |
          echo "Pulling Docker image: ${{ env.TARGET_IMAGE }}"
          docker pull ${{ env.TARGET_IMAGE }}

      - name: Deploy to production environment
        run: |
          echo "Deploying to production environment..."

          # Stop and remove existing container
          docker stop ${{ env.CONTAINER_NAME }} || true
          docker rm ${{ env.CONTAINER_NAME }} || true

          # Start new container
          docker run -d \
            --name ${{ env.CONTAINER_NAME }} \
            --restart unless-stopped \
            -p ${{ env.DEPLOY_PORT }}:8080 \
            -e JWT_SECRET_KEY="${{ secrets.JWT_SECRET_KEY }}" \
            -e PASSWORD_SECRET_KEY="${{ secrets.PASSWORD_SECRET_KEY }}" \
            -e PORTONE_STORE_ID="${{ secrets.PORTONE_STORE_ID }}" \
            -e PORTONE_AUTH_TOKEN="${{ secrets.PORTONE_AUTH_TOKEN }}" \
            -e DB_URL="${{ secrets.DB_URL }}" \
            -e DB_USERNAME="${{ secrets.DB_USERNAME }}" \
            -e DB_PASSWORD="${{ secrets.DB_PASSWORD }}" \
            ${{ env.TARGET_IMAGE }}

          echo "Production container started successfully"
          docker ps --filter "name=${{ env.CONTAINER_NAME }}"

      - name: Verify deployment
        run: |
          echo "Waiting for application to start..."
          sleep 15

          # Check if container is running
          if docker ps --filter "name=${{ env.CONTAINER_NAME }}" --filter "status=running" | grep -q ${{ env.CONTAINER_NAME }}; then
            echo "‚úÖ Production container is running successfully"

            # Health check with retry
            for i in {1..5}; do
              if curl -f -s http://localhost:${{ env.DEPLOY_PORT }}/actuator/health > /dev/null 2>&1; then
                echo "‚úÖ Production health check passed"
                break
              else
                echo "‚è≥ Production health check attempt $i/5 failed, retrying in 5s..."
                sleep 5
              fi

              if [ $i -eq 5 ]; then
                echo "‚ö†Ô∏è Production health check endpoint not responding"
                echo "üìã Container logs:"
                docker logs --tail 20 ${{ env.CONTAINER_NAME }}
              fi
            done
          else
            echo "‚ùå Production container failed to start"
            docker logs ${{ env.CONTAINER_NAME }}
            exit 1
          fi

      - name: Clean up old Docker images
        run: |
          echo "Cleaning up old Docker images..."

          # Get current image ID
          CURRENT_IMAGE_ID=$(docker images ${{ env.TARGET_IMAGE }} --format "{{.ID}}" | head -n 1)
          echo "Current image ID: $CURRENT_IMAGE_ID"

          # Get all images for this repository (excluding the current one)
          OLD_IMAGES=$(docker images ${{ env.REGISTRY }}/${{ env.DOCKER_USERNAME }}/${{ env.IMAGE_NAME }} --format "{{.ID}} {{.Tag}}" | grep -v "$CURRENT_IMAGE_ID" | head -n -1 | awk '{print $1}')

          if [ -n "$OLD_IMAGES" ]; then
            echo "Removing old images (keeping 1 backup):"
            echo "$OLD_IMAGES"
            echo "$OLD_IMAGES" | xargs -r docker rmi -f || true
          else
            echo "No old images to clean up"
          fi

          # Clean up dangling images
          echo "Cleaning up dangling images..."
          docker image prune -f || true

      - name: Show deployment summary
        run: |
          echo "üöÄ Deployment Summary"
          echo "===================="
          echo "Environment: prod"
          echo "Branch: ${{ github.ref_name }}"
          echo "Built Image: ${{ env.TARGET_IMAGE }}"
          echo "Container: ${{ env.CONTAINER_NAME }}"
          echo "Port: ${{ env.DEPLOY_PORT }}"
          echo ""
          echo "Container Status:"
          docker ps --filter "name=${{ env.CONTAINER_NAME }}" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
          echo ""
          echo "üåê Access URL: http://localhost:${{ env.DEPLOY_PORT }}"