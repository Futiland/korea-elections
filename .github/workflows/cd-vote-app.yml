name: CD - Deploy Vote Application

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        type: choice
        options:
          - dev
          - prod
        default: 'dev'
      image_tag:
        description: 'Docker image tag to deploy (e.g., develop, main, develop-abc1234)'
        required: true
        type: string
        default: 'develop'

env:
  REGISTRY: docker.io
  IMAGE_NAME: vote-app

jobs:
  deploy:
    name: Deploy to ${{ inputs.environment }}
    runs-on: ${{ inputs.environment == 'prod' && 'ubuntu-latest' || 'nppd_on-prem' }}
    environment: ${{ inputs.environment }}

    steps:
      - name: Set up environment variables
        run: |
          if [[ "${{ inputs.environment }}" == "prod" ]]; then
            echo "DOCKER_USERNAME=${{ secrets.PROD_DOCKER_ID }}" >> $GITHUB_ENV
            echo "DOCKER_PASSWORD=${{ secrets.PROD_DOCKER_PW }}" >> $GITHUB_ENV
            echo "SOURCE_DOCKER_USERNAME=${{ secrets.DEV_DOCKER_ID }}" >> $GITHUB_ENV
            echo "CONTAINER_NAME=vote-app-prod" >> $GITHUB_ENV
            echo "DEPLOY_PORT=8080" >> $GITHUB_ENV
          else
            echo "DOCKER_USERNAME=${{ secrets.DEV_DOCKER_ID }}" >> $GITHUB_ENV
            echo "DOCKER_PASSWORD=${{ secrets.DEV_DOCKER_PW }}" >> $GITHUB_ENV
            echo "SOURCE_DOCKER_USERNAME=${{ secrets.DEV_DOCKER_ID }}" >> $GITHUB_ENV
            echo "CONTAINER_NAME=vote-app-dev" >> $GITHUB_ENV
            echo "DEPLOY_PORT=8081" >> $GITHUB_ENV
          fi

          echo "SOURCE_IMAGE=${{ env.REGISTRY }}/${{ env.SOURCE_DOCKER_USERNAME }}/${{ env.IMAGE_NAME }}:${{ inputs.image_tag }}" >> $GITHUB_ENV
          echo "TARGET_IMAGE=${{ env.REGISTRY }}/${{ env.DOCKER_USERNAME }}/${{ env.IMAGE_NAME }}:latest-${{ inputs.environment }}" >> $GITHUB_ENV

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ env.DOCKER_USERNAME }}
          password: ${{ env.DOCKER_PASSWORD }}

      - name: Pull and retag image for deployment
        run: |
          echo "Pulling source image: ${{ env.SOURCE_IMAGE }}"
          docker pull ${{ env.SOURCE_IMAGE }}

          echo "Tagging image for deployment: ${{ env.TARGET_IMAGE }}"
          docker tag ${{ env.SOURCE_IMAGE }} ${{ env.TARGET_IMAGE }}

          if [[ "${{ inputs.environment }}" == "prod" ]]; then
            echo "Pushing to production registry..."
            docker push ${{ env.TARGET_IMAGE }}
          fi

      - name: Stop and remove existing container
        run: |
          echo "Stopping existing container if running..."
          docker stop ${{ env.CONTAINER_NAME }} || true
          docker rm ${{ env.CONTAINER_NAME }} || true
          echo "Container cleanup completed"

      - name: Start new container
        run: |
          docker run -d \
            --name ${{ env.CONTAINER_NAME }} \
            --restart unless-stopped \
            -p ${{ env.DEPLOY_PORT }}:8080 \
            ${{ env.TARGET_IMAGE }}

          echo "Container started successfully"
          docker ps --filter "name=${{ env.CONTAINER_NAME }}"

      - name: Verify deployment
        run: |
          echo "Waiting for application to start..."
          sleep 15

          # Check if container is running
          if docker ps --filter "name=${{ env.CONTAINER_NAME }}" --filter "status=running" | grep -q ${{ env.CONTAINER_NAME }}; then
            echo "‚úÖ Container is running successfully"

            # Health check with retry
            for i in {1..5}; do
              if curl -f -s http://localhost:${{ env.DEPLOY_PORT }}/actuator/health > /dev/null 2>&1; then
                echo "‚úÖ Application health check passed"
                break
              else
                echo "‚è≥ Health check attempt $i/5 failed, retrying in 5s..."
                sleep 5
              fi

              if [ $i -eq 5 ]; then
                echo "‚ö†Ô∏è Health check endpoint not responding (this might be normal if endpoint doesn't exist)"
                echo "üìã Container logs:"
                docker logs --tail 20 ${{ env.CONTAINER_NAME }}
              fi
            done
          else
            echo "‚ùå Container failed to start"
            echo "üìã Container logs:"
            docker logs ${{ env.CONTAINER_NAME }}
            exit 1
          fi

      - name: Clean up old Docker images
        run: |
          echo "Cleaning up old Docker images..."

          # Get current image ID
          CURRENT_IMAGE_ID=$(docker images ${{ env.TARGET_IMAGE }} --format "{{.ID}}" | head -n 1)
          echo "Current image ID: $CURRENT_IMAGE_ID"

          # Get all images for this repository (excluding the current one)
          OLD_IMAGES=$(docker images ${{ env.REGISTRY }}/${{ env.DOCKER_USERNAME }}/${{ env.IMAGE_NAME }} --format "{{.ID}} {{.Tag}}" | grep -v "$CURRENT_IMAGE_ID" | head -n -1 | awk '{print $1}')

          if [ -n "$OLD_IMAGES" ]; then
            echo "Removing old images (keeping 1 backup):"
            echo "$OLD_IMAGES"
            echo "$OLD_IMAGES" | xargs -r docker rmi -f || true
          else
            echo "No old images to clean up"
          fi

          # Clean up dangling images
          echo "Cleaning up dangling images..."
          docker image prune -f || true

      - name: Show deployment summary
        run: |
          echo "üöÄ Deployment Summary"
          echo "===================="
          echo "Environment: ${{ inputs.environment }}"
          echo "Source Image: ${{ env.SOURCE_IMAGE }}"
          echo "Deployed Image: ${{ env.TARGET_IMAGE }}"
          echo "Container: ${{ env.CONTAINER_NAME }}"
          echo "Port: ${{ env.DEPLOY_PORT }}"
          echo ""
          echo "Container Status:"
          docker ps --filter "name=${{ env.CONTAINER_NAME }}" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
          echo ""
          echo "üåê Access URL: http://localhost:${{ env.DEPLOY_PORT }}"